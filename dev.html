<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dune - Atreides Sheet</title>
<!-- flaceholder favicon line here, will be added in prod -->
  <link rel="manifest" href="manifest.json">
    <style>
        body { font-family: Arial, sans-serif; padding: 15px; font-size: 16px;}
        .container { display: flex; justify-content: space-around; flex-wrap: wrap; }
        .faction { border: 1px solid #000; padding: 1px; width: 15%; min-width: 175px; }
.card-pool {
    margin: 10px auto;
    padding: 1px;

    display: flex;
    flex-direction: column; /* Stack items vertically */
    align-items: center; /* Center everything */
    max-width: 400px; /* Prevent columns from spreading too far apart */
}
.faction h2 {

    border-bottom: 4px solid; /* Thick underline */
    padding-bottom: 5px; /* Adds spacing between underline and text */
}

#atreides h2 { border-color: green; }
#gesserit h2 { border-color: blue; }
#emperor h2 { border-color: red; }
#fremen h2 { border-color: yellow; }
#guild h2 { border-color: orange; }
#harkonnen h2 { border-color: black; }


.card-columns {
    display: flex;
    flex-wrap: wrap;
    justify-content: center; /* Center columns */
    gap: 5px; /* Add spacing between columns */
    width: 100%;
}

.card-column {
    flex: 1;
    min-width: 45%; /* Keep two columns even on small screens */
}
    input[type="text"] {
        width: 85%; /* Default width */
    }

		.money-controls { display: flex; gap: 15px; justify-content: center; }
        
        @media (max-width: 500px) {
    body {
        font-size: 15px;
        padding: 5px; /* Reduce body padding on mobile */
    }
    
    .container { 
        display: grid; 
        grid-template-columns: repeat(2, 1fr); 
        gap: 10px; 
        justify-content: center;
    }
    
    .faction { 
        width: 175px; 
    }
    
    input[type="text"] {
        width: 70%; /* Make it smaller on phones */
    }
    
    /* Tab improvements */
    .tab-container {
        width: 100%;
        max-width: 100%;
        margin: 0 -5px; /* Align with reduced body padding */
        padding: 0;
    }
    
    .tab-name {
        padding: 6px 5px;
        margin-right: 1px;
        font-size: 13px;
        flex-grow: 1; /* Make tabs expand to fill space */
        text-align: center;
    }
    
    .tab-panel {
        margin: 0;
        padding: 5px;
        border-left: 0;
        border-right: 0;
        border-radius: 0;
        width: 100%;
    }
    
    .card-columns {
        gap: 5px;
    }
}
  

/* Discard pile styling */
.discard-pile {
    margin: 20px auto;
    padding: 1px;
    display: flex;
    flex-direction: column;
    align-items: center;
    max-width: 400px;

}

.discard-pile h2 {
    border-bottom: 4px solid #8B4513; /* Brown border for discard pile */
    padding-bottom: 5px;
    color: #8B4513;
}

.restore-button {
    margin: 10px 0;
    padding: 8px 15px;
    background-color: #8B4513;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.restore-button:hover {
    background-color: #6b3510;
}
/* Card popup styling */
.card-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.7);
    z-index: 1000;
    justify-content: center;
    align-items: center;
}

.card-svg {
    max-width: 90%;
    max-height: 90%;
    background-color: white;
    padding: 10px;
    border-radius: 5px;
}

/* Tab styling */
.tab-container {
  width: 100%;
}

.tab-name {
  display: inline-block;
  padding: 10px 15px;
  cursor: pointer;
  border: 1px solid #ccc;
  border-bottom: none;
  border-radius: 5px 5px 0 0;
  background-color: #f1f1f1;
  margin-right: 5px;
  
}

/* Hide radio buttons */
input[name="tab-selector"] {
  display: none;
}

/* Tab content styling */
.tab-panel {
  display: none;
  padding: 1px;
  border: 1px solid #ccc;
  border-radius: 0 5px 5px 5px;
}

/* Show active tab */
#tab-link-01:checked ~ .tab-content #tab-01,
#tab-link-02:checked ~ .tab-content #tab-02,
#tab-link-03:checked ~ .tab-content #tab-03 {
  display: block;
}

/* Style for active tab label */
#tab-link-01:checked + .tab-name,
#tab-link-02:checked + .tab-name,
#tab-link-03:checked + .tab-name {
  background-color: white;
  border-bottom: 1px solid white;
  position: relative;
  z-index: 1;
}

/* Expansion pool styling */
.expansion-pool {
    margin: 20px auto;
    padding: 1px;
    display: flex;
    flex-direction: column;
    align-items: center;
    max-width: 400px;
}

.expansion-pool h2 {
    border-bottom: 4px solid #4B0082; /* Indigo border for expansion pile */
    padding-bottom: 5px;
    color: #4B0082;
}


/* Faction Management Button */
.faction-management {
  margin: 10px 0 20px 0;
  text-align: center;
}

.manage-factions-btn {
  padding: 8px 15px;
  background-color: #4a4a4a;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 16px;
}

.manage-factions-btn:hover {
  background-color: #333;
}

/* Faction Modal Styles */
.faction-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.7);
  z-index: 1000;
  padding: 20px;
  box-sizing: border-box;
}

.faction-modal-content {
  background-color: white;
  margin: 10% auto;
  padding: 20px;
  border-radius: 5px;
  max-width: 500px;
  max-height: 80vh;
  overflow-y: auto;
}

.faction-modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid #ccc;
  padding-bottom: 10px;
  margin-bottom: 15px;
}

.faction-modal-header h3 {
  margin: 0;
}

.close-modal {
  font-size: 24px;
  cursor: pointer;
}

.faction-selection {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}

.faction-option {
  padding: 5px;
}

.expansion-faction {
  background-color: #f8f8f8;
  border-radius: 3px;
}

.faction-modal-footer {
  text-align: center;
  margin-top: 20px;
  padding-top: 10px;
  border-top: 1px solid #ccc;
}

.apply-factions-btn {
  padding: 8px 20px;
  background-color: #4CAF50;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 16px;
}

.apply-factions-btn:hover {
  background-color: #3e8e41;
}

/* Additional styles for expansion factions */
#ecaz h2 { border-color: #FF69B4; } /* Pink */
#moritani h2 { border-color: #008080; } /* Teal */
#ixians h2 { border-color: #bbb0a5; } /* Greige */
#tleilaxu h2 { border-color: #800080; } /* Purple */
#choam h2 { 
  border-color: #000; 
  position: relative;
}
#choam h2:after {
  content: '';
  position: absolute;
  bottom: -4px;
  left: 0;
  right: 0;
  height: 4px;
  background: repeating-linear-gradient(45deg, #ff0000, #ff0000 10px, #000 10px, #000 20px);
}
#richese h2 { border-color: #D3D3D3; } /* Light Gray */

@media (max-width: 500px) {
  .faction-selection {
    grid-template-columns: 1fr;
  }
}

</style>
</head>
<body>
    <h1>Atreides Tracker Sheet</h1>
<!-- Add this HTML section right after the main heading and before the tab container -->
<div class="faction-management">
  <button id="manageFactions" class="manage-factions-btn">Manage Factions</button>
  
  <!-- Faction Selection Modal -->
  <div id="factionModal" class="faction-modal">
    <div class="faction-modal-content">
      <div class="faction-modal-header">
        <h3>Select Factions</h3>
        <span class="close-modal">&times;</span>
      </div>
      <div class="faction-selection">
        <!-- Original factions -->
        <div class="faction-option">
          <input type="checkbox" id="faction-atreides" checked>
          <label for="faction-atreides">Atreides (Green) - 10 spice</label>
        </div>
        <div class="faction-option">
          <input type="checkbox" id="faction-harkonnen">
          <label for="faction-harkonnen">Harkonnen (Black) - 10 spice</label>
        </div>
        <div class="faction-option">
          <input type="checkbox" id="faction-emperor">
          <label for="faction-emperor">Emperor (Red) - 10 spice</label>
        </div>
        <div class="faction-option">
          <input type="checkbox" id="faction-fremen">
          <label for="faction-fremen">Fremen (Yellow) - 3 spice</label>
        </div>
        <div class="faction-option">
          <input type="checkbox" id="faction-guild">
          <label for="faction-guild">Guild (Orange) - 5 spice</label>
        </div>
        <div class="faction-option">
          <input type="checkbox" id="faction-gesserit">
          <label for="faction-gesserit">Gesserit (Blue) - 5 spice</label>
        </div>
        
        <!-- Expansion factions -->
        <div class="faction-option expansion-faction">
          <input type="checkbox" id="faction-ecaz">
          <label for="faction-ecaz">Ecaz (Pink) - 12 spice</label>
        </div>
        <div class="faction-option expansion-faction">
          <input type="checkbox" id="faction-moritani">
          <label for="faction-moritani">Moritani (Teal) - 12 spice</label>
        </div>
        <div class="faction-option expansion-faction">
          <input type="checkbox" id="faction-ixians">
          <label for="faction-ixians">Ixians (Greige) - 10 spice</label>
        </div>
        <div class="faction-option expansion-faction">
          <input type="checkbox" id="faction-tleilaxu">
          <label for="faction-tleilaxu">Tleilaxu (Purple) - 5 spice</label>
        </div>
        <div class="faction-option expansion-faction">
          <input type="checkbox" id="faction-choam">
          <label for="faction-choam">Choam (Red/Black) - 2 spice</label>
        </div>
        <div class="faction-option expansion-faction">
          <input type="checkbox" id="faction-richese">
          <label for="faction-richese">Richese (Light Gray) - 5 spice</label>
        </div>
      </div>
      <div class="faction-modal-footer">
        <button id="applyFactions" class="apply-factions-btn">Apply Changes</button>
      </div>
    </div>
  </div>
</div>

<!-- Treachery, Discard, and Expansion Piles tabs -->
<div class="tab-container">
  <input name="tab-selector" type="radio" id="tab-link-01" checked>
  <label for="tab-link-01" class="tab-name">Treachery Pile</label>
  <input name="tab-selector" type="radio" id="tab-link-02">
  <label for="tab-link-02" class="tab-name">Discard Pile</label>
  <input name="tab-selector" type="radio" id="tab-link-03">
  <label for="tab-link-03" class="tab-name">Expansion</label>
  
  <!-- Tab Content -->
  <div class="tab-content">
    <!-- Treachery Pile Tab Content -->
    <div id="tab-01" class="tab-panel">
      <div class="card-pool">
        <!-- <h2>Treachery Card Pool</h2> -->
        <div class="card-columns">
          <div class="card-column" id="cardPool1"></div>
          <div class="card-column" id="cardPool2"></div>
        </div>
      </div>
    </div>
    
    <!-- Discard Pile Tab Content -->
    <div id="tab-02" class="tab-panel">
      <div class="discard-pile">
        <!-- <h2>Discard Pile</h2> -->
        <div class="card-columns">
          <div class="card-column" id="discardPool1"></div>
          <div class="card-column" id="discardPool2"></div>
        </div>
        <button id="restoreAllCards" class="restore-button">Return All Cards to Pool</button>
      </div>
    </div>
    
    <!-- Expansion Pool Tab Content -->
    <div id="tab-03" class="tab-panel">
      <div class="expansion-pool">
        <div class="card-columns">
          <div class="card-column" id="expansionPool1"></div>
          <div class="card-column" id="expansionPool2"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- This will be the container for faction cards, replace your existing container div with this -->
<div id="factionContainer" class="container">
  <!-- Faction cards will be generated here dynamically -->
</div>    

<!-- JS code begins -->
<script>
// Card pool contents
let cardPool = {
    "Worthless": 5,
    "Weapon- Projectile": 4,
    "Defense- Projectile": 4,
    "Weapon- Poison": 4,
    "Defense- Poison": 4,
    "Lasgun": 1,
    "Cheap Hero": 3,
    "Family Atomics": 1,
    "Hajr (movement)": 1,
    "Karama": 2,
    "Ghola (HeroHeal)": 1,
    "Truthtrance": 2,
    "Weather Control": 1
};

// Expansion cards
let expansionCards = {
    "Weapon- Projectile": 1,
    "Weapon- Poison": 1,
    "Defense- Projectile": 1,
    "Defense- Poison": 1,
    "Worthless": 1,
    "Poison Tooth": 1,
    "Amal": 1,
    "Recruits": 1,
    "Harass & Withdraw": 1,
    "Spice Harvester": 1,
    "Thumper": 1
};

// Initialize expansion pool with the expansion cards
let expansionPool = {};
for (let card in expansionCards) {
    expansionPool[card] = expansionCards[card];
}

// Track discarded cards
let discardPile = {};
    
// Initialize discard pile with 0 counts
for (let card in cardPool) {
    discardPile[card] = 0;
}

// Define all available factions with their starting money
const allFactions = {
  'atreides': { money: 10, name: 'Atreides', color: 'green' },
  'gesserit': { money: 5, name: 'Gesserit', color: 'blue' },
  'emperor': { money: 10, name: 'Emperor', color: 'red' },
  'fremen': { money: 3, name: 'Fremen', color: 'yellow' },
  'guild': { money: 5, name: 'Guild', color: 'orange' },
  'harkonnen': { money: 10, name: 'Harkonnen', color: 'black' },
  // Expansion factions
  'ecaz': { money: 12, name: 'Ecaz', color: 'pink' },
  'moritani': { money: 12, name: 'Moritani', color: 'teal' },
  'ixians': { money: 10, name: 'Ixians', color: 'greige' },
  'tleilaxu': { money: 5, name: 'Tleilaxu', color: 'purple' },
  'choam': { money: 2, name: 'Choam', color: 'red/black' },
  'richese': { money: 5, name: 'Richese', color: 'light gray' }
};

// Initial active factions - will be overridden by localStorage if available
let activeFactions = ['atreides'];

// Modal control functions
function openFactionModal() {
  document.getElementById('factionModal').style.display = 'block';
  
  // Set checkboxes based on active factions
  for (let faction in allFactions) {
    document.getElementById(`faction-${faction}`).checked = activeFactions.includes(faction);
  }
}

function closeFactionModal() {
  document.getElementById('factionModal').style.display = 'none';
}

function applyFactionChanges() {
  // Get selected factions
  const newActiveFactions = [];
  for (let faction in allFactions) {
    if (document.getElementById(`faction-${faction}`).checked) {
      newActiveFactions.push(faction);
    }
  }
  
  // Update active factions
  activeFactions = newActiveFactions;
  
  // Regenerate faction UI
  generateFactionCards();
  
  // Save to localStorage
  saveData();
  
  // Close modal
  closeFactionModal();
}

// Generate faction cards based on active factions
function generateFactionCards() {
  const container = document.getElementById('factionContainer');
  container.innerHTML = ''; // Clear existing content
  
  // Create cards for each active faction
  activeFactions.forEach(faction => {
    const factionData = allFactions[faction];
    const factionMoney = getMoneyForFaction(faction);
    
    const factionCard = document.createElement('div');
    factionCard.className = 'faction';
    factionCard.id = faction;
    
    factionCard.innerHTML = `
      <h2>${factionData.name}</h2>
      <h3>Money: <span id="money-${faction}">${factionMoney}</span></h3>
      <div class="money-controls">
        <button onclick="adjustMoney('${faction}', -5)">-5</button>
        <button onclick="adjustMoney('${faction}', -1)">-1</button>
        <button onclick="adjustMoney('${faction}', 1)">+1</button>
        <button onclick="adjustMoney('${faction}', 5)">+5</button>
      </div>
      <h3>Treachery Cards</h3>
      <select id="cardDropdown-${faction}">
        ${Object.keys(cardPool).map(card => `<option value="${card}">${card}</option>`).join('')}
      </select>
      <button onclick="addCard('${faction}')">Add Card</button>
      <ul id="cardList-${faction}"></ul>
      <h3>Traitors</h3>
      <input type="text" id="traitorInput-${faction}" placeholder="Enter traitor name">
      <button onclick="addTraitor('${faction}')">Add Traitor</button>
      <ul id="traitorList-${faction}"></ul>
    `;
    
    container.appendChild(factionCard);
  });
  
  // Restore cards and traitors from localStorage if available
  restoreFactionData();
}

// Helper function to get money for a faction (either from saved state or default)
function getMoneyForFaction(faction) {
  // Try to get from saved state first
  let savedData = localStorage.getItem("duneTrackerData");
  if (savedData) {
    savedData = JSON.parse(savedData);
    if (savedData.money && savedData.money[faction] !== undefined) {
      return savedData.money[faction];
    }
  }
  
  // If no saved state, return default
  return allFactions[faction].money;
}

// Helper function to restore cards and traitors after regenerating faction cards
function restoreFactionData() {
  let savedData = localStorage.getItem("duneTrackerData");
  if (!savedData) return;
  
  savedData = JSON.parse(savedData);
  
  // Restore Treachery Cards for each faction
  for (let faction of activeFactions) {
    if (savedData.treacheryCards && savedData.treacheryCards[faction]) {
      const cardList = document.getElementById(`cardList-${faction}`);
      cardList.innerHTML = ""; // Clear previous content
      savedData.treacheryCards[faction].forEach(cardName => {
        addCardToFaction(faction, cardName);
      });
    }
    
    // Restore Traitor List
    if (savedData.traitors && savedData.traitors[faction]) {
      const traitorList = document.getElementById(`traitorList-${faction}`);
      traitorList.innerHTML = ""; // Clear previous content
      savedData.traitors[faction].forEach(name => {
        let li = document.createElement('li');
        li.textContent = name;
        traitorList.appendChild(li);
      });
    }
  }
}

// Card functions
function updateCardPool() {
    let pool1 = document.getElementById('cardPool1');
    let pool2 = document.getElementById('cardPool2');
    pool1.innerHTML = '';
    pool2.innerHTML = '';
    let index = 0;
    for (let card in cardPool) {
        let li = document.createElement('li');
        let cardText = document.createElement('span');
        cardText.textContent = `${card}: ${cardPool[card]}`;
        cardText.style.cursor = 'pointer';
        cardText.onclick = function() {
            showCardSvg(card);
        };
        li.appendChild(cardText);
        if (index % 2 === 0) {
            pool1.appendChild(li);
        } else {
            pool2.appendChild(li);
        }
        index++;
    }
}
    
// Function to update the discard pile display
function updateDiscardPile() {
    let pool1 = document.getElementById('discardPool1');
    let pool2 = document.getElementById('discardPool2');
    pool1.innerHTML = '';
    pool2.innerHTML = '';
    let index = 0;
    let hasCards = false;
    
    for (let card in discardPile) {
        if (discardPile[card] > 0) {
            hasCards = true;
            let li = document.createElement('li');
            let cardText = document.createElement('span');
            cardText.textContent = `${card}: ${discardPile[card]}`;
            cardText.style.cursor = 'pointer';
            cardText.onclick = function() {
                showCardSvg(card);
            };
            li.appendChild(cardText);
            if (index % 2 === 0) {
                pool1.appendChild(li);
            } else {
                pool2.appendChild(li);
            }
            index++;
        }
    }
    // If no cards in discard pile, show a message
    if (!hasCards) {
        let li = document.createElement('li');
        li.textContent = "No cards discarded";
        pool1.appendChild(li);
    }
}

// Function to update the expansion pool display
function updateExpansionPool() {
    let pool1 = document.getElementById('expansionPool1');
    let pool2 = document.getElementById('expansionPool2');
    pool1.innerHTML = '';
    pool2.innerHTML = '';
    let index = 0;
    let hasCards = false;
    
    for (let card in expansionPool) {
        if (expansionPool[card] > 0) {
            hasCards = true;
            let li = document.createElement('li');
            let cardSpan = document.createElement('span');
            cardSpan.textContent = `${card}: ${expansionPool[card]}`;
            cardSpan.style.cursor = 'pointer';
            cardSpan.onclick = function() {
                showCardSvg(card);
            };
            
            // Add button to add card to main pool
            let addButton = document.createElement('button');
            addButton.textContent = " [Add to Main]";
            addButton.style.marginLeft = "10px";
            addButton.onclick = function() {
                addToMainPool(card);
            };
            
            li.appendChild(cardSpan);
            li.appendChild(addButton);
            
            if (index % 2 === 0) {
                pool1.appendChild(li);
            } else {
                pool2.appendChild(li);
            }
            index++;
        }
    }
    
    // If no cards in expansion pool, show a message
    if (!hasCards) {
        let li = document.createElement('li');
        li.textContent = "All expansion cards have been added to the main pool";
        pool1.appendChild(li);
    }
}

// Function to add a card from expansion pool to main pool
function addToMainPool(cardName) {
    if (expansionPool[cardName] > 0) {
        // Check if card exists in main pool, add if it does
        if (cardName in cardPool) {
            cardPool[cardName]++;
        } else {
            // Add new card type to main pool if it doesn't exist
            cardPool[cardName] = 1;
            
            // Also add to discard pile tracking with 0 count
            discardPile[cardName] = 0;
            
            // Add to card dropdown options for all factions
            activeFactions.forEach(faction => {
                let dropdown = document.getElementById(`cardDropdown-${faction}`);
                let option = document.createElement('option');
                option.value = cardName;
                option.textContent = cardName;
                dropdown.appendChild(option);
            });
        }
        
        // Remove card from expansion pool
        expansionPool[cardName]--;
        
        // Update displays
        updateCardPool();
        updateExpansionPool();
        
        // Save the game state
        saveData();
    }
}

// Assigning cards to each faction
function addCard(faction) {
    let dropdown = document.getElementById(`cardDropdown-${faction}`);
    let cardName = dropdown.value;
    if (cardName && cardPool[cardName] > 0) {
        let li = document.createElement('li');
        li.textContent = cardName;

        let returnBtn = document.createElement('button');
        returnBtn.textContent = " [Return]";
        returnBtn.style.marginLeft = "10px";
        returnBtn.onclick = function () {
            returnCard(faction, cardName, li);
        };

        li.appendChild(returnBtn);
        document.getElementById(`cardList-${faction}`).appendChild(li);
        cardPool[cardName]--;
        updateCardPool();
        saveData();
    }
}

// Function to add card to a faction (ensuring return button exists)
function addCardToFaction(faction, cardName) {
    let li = document.createElement('li');
    li.textContent = cardName;

    let returnBtn = document.createElement('button');
    returnBtn.textContent = " [Return]";
    returnBtn.style.marginLeft = "10px";
    returnBtn.onclick = function () {
        returnCard(faction, cardName, li);
    };

    li.appendChild(returnBtn);
    document.getElementById(`cardList-${faction}`).appendChild(li);
}

// Send card to discard pile instead of directly back to Treachery pool
function returnCard(faction, cardName, cardElement) {
    // Increase the count in the discard pile
    discardPile[cardName]++;

    // Remove card from player's list
    cardElement.remove();

    // Update the discard pile display
    updateDiscardPile();

    // Update the Treachery Card Pool display (unchanged card counts)
    updateCardPool();

    // Save the game state
    saveData();
}

// Function to restore all cards from discard pile to the main pool
function restoreAllCards() {
    for (let card in discardPile) {
        if (discardPile[card] > 0) {
            cardPool[card] += discardPile[card];
            discardPile[card] = 0;
        }
    }
    // Update both displays
    updateCardPool();
    updateDiscardPile();

    // Save the game state
    saveData();
}

// Function to keep track of Money
function adjustMoney(faction, amount) {
    let moneyElement = document.getElementById(`money-${faction}`);
    let currentMoney = parseInt(moneyElement.textContent);
    
    // Calculate new balance but don't let it go below 0
    let newMoney = Math.max(0, currentMoney + amount);
    
    // Update the display
    moneyElement.textContent = newMoney;
    
    // Save the change
    saveData();
}

// Save data to localStorage
function saveData() {
    let gameState = {
        money: {},
        treacheryCards: {},
        traitors: {},
        notes: document.getElementById("miscNotes")?.value || "",
        cardPool: {},
        discardPile: {},
        expansionPool: {},
        activeFactions: activeFactions // Save active factions list
    };

    // Save money values for active factions
    activeFactions.forEach(faction => {
        const moneyElement = document.getElementById(`money-${faction}`);
        if (moneyElement) {
            gameState.money[faction] = parseInt(moneyElement.textContent);
        }
    });

    // Save Treachery Cards for each active faction
    activeFactions.forEach(faction => {
        const cardList = document.getElementById(`cardList-${faction}`);
        if (cardList) {
            gameState.treacheryCards[faction] = Array.from(cardList.children).map(li => li.textContent.replace(" [Return]", ""));
        } else {
            gameState.treacheryCards[faction] = [];
        }
    });

    // Save Traitor names for each active faction
    activeFactions.forEach(faction => {
        const traitorList = document.getElementById(`traitorList-${faction}`);
        if (traitorList) {
            gameState.traitors[faction] = Array.from(traitorList.children).map(li => li.textContent);
        } else {
            gameState.traitors[faction] = [];
        }
    });

    // Save current Treachery Card Pool counts
    for (let card in cardPool) {
        gameState.cardPool[card] = cardPool[card];
    }
    
    // Save current Discard Pile counts
    for (let card in discardPile) {
        gameState.discardPile[card] = discardPile[card];
    }
    
    // Save expansion pool counts
    for (let card in expansionPool) {
        gameState.expansionPool[card] = expansionPool[card];
    }

    localStorage.setItem("duneTrackerData", JSON.stringify(gameState));
}

// Load data from localStorage
function loadData() {
    let savedData = localStorage.getItem("duneTrackerData");
    if (!savedData) {
        generateFactionCards(); // Initialize with default faction (Atreides)
        updateCardPool();
        updateDiscardPile();
        updateExpansionPool();
        return;
    }
    
    savedData = JSON.parse(savedData);
    
    // Restore active factions list if available
    if (savedData.activeFactions && Array.isArray(savedData.activeFactions)) {
        activeFactions = savedData.activeFactions;
    }
    
    // Generate faction cards based on active factions
    generateFactionCards();

    // Restore Treachery Card Pool counts
    if (savedData.cardPool) {
        cardPool = savedData.cardPool;
        updateCardPool();
    }
    
    // Restore Discard Pile counts
    if (savedData.discardPile) {
        discardPile = savedData.discardPile;
        updateDiscardPile();
    }
    
    // Restore Expansion Pool counts
    if (savedData.expansionPool) {
        expansionPool = savedData.expansionPool;
    } else {
        // If no expansion pool in saved data, initialize it
        expansionPool = {};
        for (let card in expansionCards) {
            expansionPool[card] = expansionCards[card];
        }
    }
    
    updateExpansionPool();

    // Restore Misc. Notes
    if (savedData.notes) {
        document.getElementById("miscNotes").value = savedData.notes;
    }
}

// Function to display cards when they are clicked in the Treachery Pool or Expansion Pool
function showCardSvg(cardName) {
    const modal = document.getElementById('cardModal');
    const svgContainer = document.getElementById('cardSvgContainer');
    
    // Set the SVG based on card name
    let svgContent = getCardSvg(cardName);
    svgContainer.innerHTML = svgContent;
    
    // Show the modal
    modal.style.display = 'flex';
    
    // Prevent clicks on the SVG from closing the modal
    svgContainer.onclick = function(event) {
        event.stopPropagation();
    };
}

function closeCardModal() {
    document.getElementById('cardModal').style.display = 'none';
}

// Assign SVGs to each card
function getCardSvg(cardName) {
    // SVG data for each card (actual paths will be added in prod)
    const svgData = {
        "Worthless": `<svg width="822" height="1122" version="1.1" viewBox="0 0 822 1122" xml:space="preserve" xmlns="http://www.w3.org/2000/svg"><path d="m406.5 80.008c-359.66 1e-6 -323.99-0.76908-328.04 7.0605-2.7494 5.3168-2.4921...  0h215v11h-215v-5.5z"/></svg>`,
        "Weapon- Projectile": `<svg width="822" height="1122" viewBox="0 0 822 1122" xmlns="http://www.w3.org/2000/svg"><text x="411" y="561" text-anchor="middle" font-size="40">Projectile Weapon</text></svg>`,
        "Defense- Projectile": `<svg width="822" height="1122" viewBox="0 0 822 1122" xmlns="http://www.w3.org/2000/svg"><text x="411" y="561" text-anchor="middle" font-size="40">Projectile Defense</text></svg>`,
        "Weapon- Poison": `<svg width="822" height="1122" viewBox="0 0 822 1122" xmlns="http://www.w3.org/2000/svg"><text x="411" y="561" text-anchor="middle" font-size="40">Poison Weapon</text></svg>`,
        "Defense- Poison": `<svg width="822" height="1122" viewBox="0 0 822 1122" xmlns="http://www.w3.org/2000/svg"><text x="411" y="561" text-anchor="middle" font-size="40">Poison Defense</text></svg>`,
        "Lasgun": `<svg width="822" height="1122" viewBox="0 0 822 1122" xmlns="http://www.w3.org/2000/svg"><text x="411" y="561" text-anchor="middle" font-size="40">Lasgun</text></svg>`,
        "Cheap Hero": `<svg width="822" height="1122" viewBox="0 0 822 1122" xmlns="http://www.w3.org/2000/svg"><text x="411" y="561" text-anchor="middle" font-size="40">Cheap Hero</text></svg>`,
        "Family Atomics": `<svg width="822" height="1122" viewBox="0 0 822 1122" xmlns="http://www.w3.org/2000/svg"><text x="411" y="561" text-anchor="middle" font-size="40">Family Atomics</text></svg>`,
        "Hajr (movement)": `<svg width="822" height="1122" viewBox="0 0 822 1122" xmlns="http://www.w3.org/2000/svg"><text x="411" y="561" text-anchor="middle" font-size="40">Hajr</text></svg>`,
        "Karama": `<svg width="822" height="1122" viewBox="0 0 822 1122" xmlns="http://www.w3.org/2000/svg"><text x="411" y="561" text-anchor="middle" font-size="40">Karama</text></svg>`,
        "Ghola (HeroHeal)": `<svg width="822" height="1122" viewBox="0 0 822 1122" xmlns="http://www.w3.org/2000/svg"><text x="411" y="561" text-anchor="middle" font-size="40">Ghola</text></svg>`,
        "Truthtrance": `<svg width="822" height="1122" viewBox="0 0 822 1122" xmlns="http://www.w3.org/2000/svg"><text x="411" y="561" text-anchor="middle" font-size="40">Truthtrance</text></svg>`,
        "Weather Control": `<svg width="822" height="1122" viewBox="0 0 822 1122" xmlns="http://www.w3.org/2000/svg"><text x="411" y="561" text-anchor="middle" font-size="40">Weather Control</text></svg>`,
        // Add placeholders for expansion cards
        "Poison Tooth": `<svg width="822" height="1122" viewBox="0 0 822 1122" xmlns="http://www.w3.org/2000/svg"><text x="411" y="561" text-anchor="middle" font-size="40">Poison Tooth</text></svg>`,
        "Amal": `<svg width="822" height="1122" viewBox="0 0 822 1122" xmlns="http://www.w3.org/2000/svg"><text x="411" y="561" text-anchor="middle" font-size="40">Amal</text></svg>`,
        "Recruits": `<svg width="822" height="1122" viewBox="0 0 822 1122" xmlns="http://www.w3.org/2000/svg"><text x="411" y="561" text-anchor="middle" font-size="40">Recruits</text></svg>`,
        "Harass & Withdraw": `<svg width="822" height="1122" viewBox="0 0 822 1122" xmlns="http://www.w3.org/2000/svg"><text x="411" y="561" text-anchor="middle" font-size="40">Harass & Withdraw</text></svg>`,
        "Spice Harvester": `<svg width="822" height="1122" viewBox="0 0 822 1122" xmlns="http://www.w3.org/2000/svg"><text x="411" y="561" text-anchor="middle" font-size="40">Spice Harvester</text></svg>`,
        "Thumper": `<svg width="822" height="1122" viewBox="0 0 822 1122" xmlns="http://www.w3.org/2000/svg"><text x="411" y="561" text-anchor="middle" font-size="40">Thumper</text></svg>`
    };
    
    return svgData[cardName] || `<svg width="366" height="500" viewBox="0 0 822 1122" xmlns="http://www.w3.org/2000/svg"><text x="411" y="561" text-anchor="middle" font-size="40">${cardName}</text></svg>`;
}

// Keyboard event listener to close the modal with Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeCardModal();
    }
});

// Reset game data
function resetData() {
    if (confirm("Are you sure you want to reset all data? This will erase everything!")) {
        clearInterval(intervalFix);
        localStorage.removeItem("duneTrackerData");
        
        // Reset active factions to default
        activeFactions = ['atreides'];
        
        // Reset expansion pool to initial state
        expansionPool = {};
        for (let card in expansionCards) {
            expansionPool[card] = expansionCards[card];
        }
        
        location.reload(); // Reloads the page to apply reset
    }
}

// Worm Tracker Variables
let totalCards = 21;
let totalWorms = 6;
let cardsDrawn = 0;
let wormsLeft = totalWorms;

// Function to update the displayed percentages
function updateWormChances() {
    let cardsLeft = totalCards - cardsDrawn;
    if (cardsLeft <= 0) return;

    let nextCardChance = (wormsLeft / cardsLeft) * 100;
    let withinTwoChance = (1 - ((cardsLeft - wormsLeft) / cardsLeft) * ((cardsLeft - wormsLeft - 1) / (cardsLeft - 1))) * 100;

    document.getElementById("nextCardChance").textContent = nextCardChance.toFixed(2) + "%";
    document.getElementById("withinTwoChance").textContent = withinTwoChance.toFixed(2) + "%";
    document.getElementById("cardsDrawn").textContent = cardsDrawn;
    document.getElementById("cardsLeft").textContent = cardsLeft;
}

// Function to handle card draw
function drawCard(isWorm) {
    if (cardsDrawn >= totalCards) return; // Stop if all cards are drawn

    cardsDrawn++; // Increase drawn count
    if (isWorm) wormsLeft--; // Reduce worm count if a worm is drawn

    updateWormChances(); // Refresh UI
    saveData(); // Save worm tracker state
}

// Auto-save every 2 seconds
let intervalFix = setInterval(saveData, 2000);

// Initialize event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Set up faction management modal
    document.getElementById('manageFactions').addEventListener('click', openFactionModal);
    document.querySelector('.close-modal').addEventListener('click', closeFactionModal);
    document.getElementById('applyFactions').addEventListener('click', applyFactionChanges);
    
    // Set up restore button for discard pile
    document.getElementById('restoreAllCards').addEventListener('click', restoreAllCards);
    
    // Initialize faction UI and data
    loadData();
    
    // Initialize worm tracker
    updateWormChances();
});
</script>

<div class="worm-tracker" style="
    margin: 20px auto;
    padding: 15px;
    border: 1px solid black;
    max-width: 400px;
    text-align: center;">
    <h2>Worm Tracker</h2>
    <p>Next Card: <span id="nextCardChance">28.57%</span></p>
    <p>Within Two: <span id="withinTwoChance">48.69%</span></p>
    <p>Cards Drawn: <span id="cardsDrawn">0</span></p>
    <p>Cards Left: <span id="cardsLeft">21</span></p>
    <div style="display: flex; justify-content: center; gap: 15px; margin-top: 10px;">
        <button onclick="drawCard(true)" style="padding: 10px; font-size: 16px; background-color: #C4A484; color: white; border: none; cursor: pointer; border-radius: 5px;">Worm</button>
        <button onclick="drawCard(false)" style="padding: 10px; font-size: 16px; background-color: orange; color: white; border: none; cursor: pointer; border-radius: 5px;">Spice</button>
    </div>
</div>

<!-- Service Worker for PWA -->
<script>
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('service-worker.js')
            .then(registration => {
                console.log("Service Worker registered:", registration);
            })
            .catch(error => {
                console.log("Service Worker registration failed:", error);
            });
    }
</script>
<!-- Card Popup Overlay -->
<div id="cardModal" class="card-modal" onclick="closeCardModal()">
    <div id="cardSvgContainer" class="card-svg">
        <!-- SVG will be injected here -->
    </div>
</div>

</body>
<div style="text-align: center; margin-top: 20px;">
    <button onclick="resetData()" style="padding: 10px; font-size: 16px; background-color: red; color: white; margin-bottom: 20px; border: none; cursor: pointer; border-radius: 5px;">
        Reset Game Data
    </button>
</div>
    <footer style="
        width: 100%;
        /* background-color: #f1f1f1; */
        text-align: center;
        padding: 0px;
        font-size: 14px;
        /* border-top: 1px solid #ccc;
        margin-top: 20px;">
        Made by <a href="https://mayo.onl" target="none" title=""><u>oMayo</u></a>
    </footer>

</html>